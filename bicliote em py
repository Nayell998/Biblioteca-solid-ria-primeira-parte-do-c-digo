# ============================================================
#   SEÇÃO 1 — FRANCISCO
#   Persistência, leitura, salvamento e deduplicação
# ============================================================

import os
import json
from datetime import datetime
import ttkbootstrap as ttk
from ttkbootstrap.constants import *
from tkinter import messagebox

ARQUIVO = "biblioteca.json"
LOG_ARQUIVO = "log.txt"
biblioteca = []


# --- FUNÇÃO DE LOG (apoio ao sistema inteiro) ---
def registrar_log(acao, tipo="INFO"):
    try:
        with open(LOG_ARQUIVO, "a", encoding="utf-8") as log:
            data_hora = datetime.now().strftime("%d/%m/%Y %H:%M:%S")
            log.write(f"[{data_hora}] [{tipo}] {acao}\n")
    except Exception:
        pass


# --- CARREGAR DADOS DO JSON ---
def carregar_dados():
    global biblioteca
    if os.path.exists(ARQUIVO):
        try:
            with open(ARQUIVO, "r", encoding="utf-8") as f:
                data = json.load(f)
            biblioteca = []

            # Normalização dos dados
            for item in data:
                livro = {
                    "titulo": item.get("titulo", "").strip(),
                    "autor": item.get("autor", "").strip(),
                    "emprestado": bool(item.get("emprestado", False)),
                    "quem": item.get("quem"),
                    "data_cadastro": item.get("data_cadastro"),
                    "data_emprestimo": item.get("data_emprestimo"),
                    "data_devolucao": item.get("data_devolucao"),
                    "perdido": item.get("perdido", False),
                    "quem_perdeu": item.get("quem_perdeu"),
                    "data_perda": item.get("data_perda"),
                }
                biblioteca.append(livro)

            registrar_log("Dados carregados e normalizados com sucesso.")
        except Exception as e:
            registrar_log(f"Erro ao carregar dados: {e}", "ERRO")
            biblioteca = []
    else:
        biblioteca = []
        registrar_log("Nenhum arquivo encontrado. Novo arquivo será criado.")


# --- SALVAR EM JSON ---
def salvar_dados():
    try:
        with open(ARQUIVO, "w", encoding="utf-8") as f:
            json.dump(biblioteca, f, ensure_ascii=False, indent=4)
        registrar_log("Dados salvos com sucesso.")
    except Exception as e:
        registrar_log(f"Erro ao salvar dados: {e}", "ERRO")


# --- REMOVER DUPLICADOS ---
def remover_duplicados():
    global biblioteca
    vistos = set()
    novos = []
    for livro in biblioteca:
        chave = (livro.get("titulo", "").lower(), livro.get("autor", "").lower())
        if chave not in vistos:
            vistos.add(chave)
            novos.append(livro)
    biblioteca[:] = novos
    salvar_dados()